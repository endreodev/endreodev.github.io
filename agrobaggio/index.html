<!doctype html>
<html lang="pt">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Endreo Figueiredo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
</head>

<body id="content">

  <script>

    document.addEventListener('DOMContentLoaded', function() {
     
      var urlAtual = window.location.href;
      var urlClass = new URL(urlAtual);
      var codigo = urlClass.searchParams.get("code");

      if (codigo === null || codigo === undefined) {
        alert("Erro na autenticação verifique com suporte!");
      } else {

        const mensagemParaAdvpl = {
          type: "jsToAdvpl",
          data: codigo
        };
        // Envia mensagem para o advpl 
        window.parent.postMessage(mensagemParaAdvpl, "*");
        
      }
    
    });

  </script>

  <main>
    <h1 class="visually-hidden">Codigo para Integração</h1>
    <div class="b-example-divider"></div>

    <div class="px-4 pt-5 my-5 text-center border-bottom">
      <h1 class="display-4 fw-bold">Ativação de Integração</h1>
      <div class="col-lg-6 mx-auto">
        <p class="lead mb-4">
          Finalizar a autenticação
        </p>

        <!-- <div class="mb-3">
          <input type="text" class="form-control" name="code" id="code" readonly>
        </div> -->

        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center sm-12">
          <button type="button" onclick="copiarTexto()" class="btn btn-primary btn-lg px-4 sm-12">Copiar</button>
        </div>

      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
    crossorigin="anonymous"></script>

    <script>
      function copiarTexto() {
        window.parent.postMessage(codigo , "*");
        // enviarMensagem(codigo);
      }
    </script>

    <script>

      //RECEBE MENSAGEM ATRAVES DO IFRAME 
      window.addEventListener('message', function (event) {
          // Exiba a mensagem recebida do documento pai
          adicionarMensagem('Mensagem recebida!');
      });

      function adicionarMensagem(message) {
        // Criar um elemento de parágrafo para representar a mensagem
        const mensagemElemento = document.createElement('p');
        const mensagemTexto = message;
        mensagemElemento.textContent = mensagemTexto;

        // Obter a caixa do console
        const consoleBox = document.getElementById('consoleBox');
        consoleBox.appendChild(mensagemElemento);
        consoleBox.scrollTop = consoleBox.scrollHeight;
      }

      function enviarMensagem(codigo) {
        // Obter o valor do input
        // const jsonInput = document.getElementById('jsonInput').value;
        // Para identificar as mensagens enviadas para o iFrame 
        const mensagemParaAdvpl = {
          type: "jsToAdvpl",
          data: codigo
        };
        // Envia mensagem para o advpl 
        window.parent.postMessage(mensagemParaAdvpl, "*");
      }

    </script>

    <script>
      // Aqui você deve substituir 'window.parent' pelo objeto que representa a janela pai
      // window.parent.postMessage(codigo, "*");
      // alert("atualizar_dados 2")
      // window.parent.postMessage(codigo, "*");
    </script>

</body>

</html>
